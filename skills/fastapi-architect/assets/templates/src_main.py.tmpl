from __future__ import annotations

from contextlib import asynccontextmanager

from fastapi import FastAPI

from api.v1.router import router as v1_router
from core.config import settings
from services.clients.httpx_client import get_httpx_client


def _docs_enabled() -> bool:
    return settings.DEBUG


_DOCS = _docs_enabled()


@asynccontextmanager
async def lifespan(_: FastAPI):
    client = get_httpx_client()
    try:
        yield
    finally:
        await client.aclose()
        get_httpx_client.cache_clear()


app = FastAPI(
    title=settings.SERVICE_NAME,
    version=settings.APP_VERSION,
    description="__APP_TITLE__",
    docs_url="/docs" if _DOCS else None,
    redoc_url="/redoc" if _DOCS else None,
    openapi_url="/openapi.json" if _DOCS else None,
    lifespan=lifespan,
)

app.include_router(v1_router, prefix="/v1")
